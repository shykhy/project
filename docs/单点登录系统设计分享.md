## 单点登录系统设计分享

### CAS SSO 原理：

参见http://gitlab4.weicheche.cn/ip/sso

### 源码：

http://gitlab4.weicheche.cn/ip/sso.git

### 开发框架结构图：

![img](http://showdoc.wcc.cn/Public/Uploads/2020-05-23/5ec8da3e48f7a.png)

### 单点登录系统设计框图：

![img](http://showdoc.wcc.cn/Public/Uploads/2020-05-23/5ec8de6903b08.png)

### 设计说明：

- 单点登录有两大块逻辑：身份认证和会话生成；
- 身份认证有各种认证形式，属于变化的部分，我们采用策略模式应对其变化性，以达到可扩展性；
- 会话生成部分都是统一的逻辑，这部分基本不会变；
- 因而，我们将身份认证和会话生成两部分做成两个独立的模块，做到尽可能的解耦；

### 类图：

![img](http://showdoc.wcc.cn/Public/Uploads/2020-05-23/5ec8f9cdd19f9.png)
**说明：**

- 为简便起见，此处没有画仓储层类
- 此处仅画了关键类以及类之间的关键依赖关系；

### 设计的维度：

需要从横向和纵向两个维度考察系统设计。

- 纵向：**分层架构**思维。设计是自顶向下的，不断精化（细化、具体化）的；
- 在**设计-开发**的不断迭代中，进行迭代重构，实现功能下沉，以向下拓展深度和层次，将不变因素从变化因素中剥离出来，下沉到更深层（离用户、使用者更远），让变化因素保留在上层（离使用者更近）。这些下沉的类一方面变化频率比上层类低，另一方面这些功能可以被共用，因而在下沉的时候需要考虑剥离出来的功能接口定义的通用性，即功能接口定义不依赖于调用方（比如各种基础设施、微信接口服务）；
- 横向：设计的可扩展性。将变化因素剥离出来，通过设计模式、面向接口编程预留扩展点，实现可扩展性（如身份认证）。一般采用面向接口编程，将变化因素抽象成不变的接口，实现设计的稳定性；
- 纵向关注点在沉淀不变因素，横向关注点在解决变化因素；
- 无论是纵向还是横向维度，最终目标都是为了追求设计的稳定性；

### 安全考虑：

- 接入单点登录需要添加域名白名单；
- url 中传递一次性的 code 而不是 ticket（参照 OAuth2.0）；
- ip 白名单（目前没有加入白名单限制，不过功能已经有了）；