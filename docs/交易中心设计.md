### 背景：
交易活动属于公司核心业务流程，包括各种下单（油品、非油品、无感支付）、退款、储值卡充值、支付等。交易活动中涉及到多个子系统，如订单、支付、非油品、油号、券、营销引擎、积分、结算等。
目前公司没有统一的交易系统，商户端、无感支付、微信端、OS 线下订单等地方的下单各自写的代码，存在几个问题：
- 代码逻辑不统一；
- 要改一个逻辑需要多处修改；
- 商户端很多地方调的微信端，导致微信端压力大；
- OS 订单没有对接到线上，整个公司没有统一的订单数据；

### 方案：
搭建统一的交易系统（交易中台），统一处理交易相关的逻辑：下单、扣库存、支付、支付后续处理、退款。

### 功能性需求：
- 作为统一下单中台，为全公司所有端和系统提供交易相关服务，包括油品/非油品下单、储值卡充值、退款、其它涉及到下单流程的业务（如花钱购买大转盘等）。
- 需提供的核心接口：
	- **算优惠**：根据用户、商品（油品、非油品、储值卡，包括商品数量、金额）、支付方式、下单时间计算可用的最大优惠（以及优惠组合，包括券、积分）。这里会涉及到调优惠引擎、油号、用户系统、等级系统等外部系统；
	- **下单**；
	- **付款**（支持混合支付）；
	- **取消订单**（包括撤销相关权益锁定）；
	- **退款**（包括全额退款和部分退款）；
	- 以及一些**组合**接口：算优惠+下单+付款、下单+付款；

### 非功能性需求：
- 需要满足高并发、可靠性以及可扩展性要求。
- 低延迟。由于交易过程需要调用很多其他系统，交易中心需要通过缓存、并发处理等方式提高处理效率，保证低延迟响应能力。
- 需具备服务分级能力，在核心流程走通的前提下，允许非核心流程的暂时性失败。
- 需保证事务的最终一致性。非核心流程暂时性失败后，需要有事务补偿机制。
- 支持异常检测与重试，以及人工重试。
- 分期实现，需设计好OS对接以及历史数据迁移事项。

### 该系统不做什么：
交易中心是全公司统一的、通用的交易系统，不处理特定场景逻辑（比如一键加油、无感支付），特定场景逻辑需要由特定场景所在的业务系统自己处理。

### 对被调用方系统的要求：
- 由于远程调用不能保证一次调用成功（如超时、系统暂时不可用），任何接口理论上都会存在重复调用的可能，因而被调用方系统的任何接口都必须保证幂等性，防止出现诸如重复扣积分、重复发券等异常情况。
- 交易系统针对每一笔交易会存在唯一交易号，被调用系统根据交易号来保证幂等性。
- 即便有了交易号，在异常并发请求的情况下，仍然可能出现异常数据，因而被调用系统需自行保证异常并发情况下的数据完整性（如可使用 Redis 分布式锁、数据库乐观锁机制）。

### 关于交易号和订单号的区别：
- 交易号对应一次交易，订单号对应一笔订单；
- 理论上，一次交易只会对应一笔订单，但也有例外（比如撤单、合单）；
- 交易号的产生先于订单号：在交易开始时便产生交易号，而只有在下单的时候才会产生订单号；
- 因而在有些交互过程中，由于尚未产生订单号，必须通过交易号来识别；
- 目前我们很多地方以订单号为主，因而在实现中，需根据情况来看使用哪个；

### 涉及到的系统：
**用户系统**：获取用户信息。核心系统。
**油号系统**：查询商品（油品）基本信息。核心系统。
**订单系统**：下单，创建订单基本信息。核心系统。
**支付网关**：支付。核心系统。
**非油品系统**：购买非油品，以及油非互动。
**券系统**：使用优惠券、订单完成后发券。
**优惠引擎**：计算价格优惠。
**储值卡**：使用储值卡付款（以及为储值卡充值）。
**营销系统**：指fw的营销系统。记录订单使用到的营销信息。
**积分系统（包括积分规则系统）**：积分抵现、加油后送积分。
**结算系统**：记录交易信息用于做班结、财务报表以及其它统计信息。
**推送系统**：推送信息给商户端、大屏、双屏机等终端。
**发票系统**：自动开票等功能。
**通知包**：发通知。
**定级**：会员定级、查询等级信息。
**营销活动**：如满额送等，权益相关。
**OS**：线上线下订单同步。（由于目前一方面OS订单没有同步到线上订单和结算系统，另一方面很多报表是在OS实现的，所以SaaS订单会同步给OS，后面OS对接线上订单系统后，此处不再需要）。

核心系统：**用户、油号、订单、支付**，最少由这几个系统即可完成一次加油交易，相反，如果这几个系统任何一个出现问题，则无法完成交易。

### 下单流程：
下单：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-16/5f620ef489cc7.png)
**注意：**
- 用户在下单过程中可能会多次修改油枪、金额、支付方式等信息，每次修改后，交易中心需要重新计算可能的优惠组合列表，在将优惠组合返回给业务系统之前会做留存，防止在临界点发生不可预测的情况（比如分时优惠）。用户也可能会多次修改使用的优惠组合。这些过程中，不会涉及到跟订单系统的交互。
- **下单前预处理：**需要根据业务场景决定是否需要走“先行扣减（锁定）”模式。比如手机端一键加油，该场景下并不适合走先行扣减模式，因为用户在调起微信支付后还没有真正支付前，可能会取消支付，修改订单信息，此时只能算重新下单，如果走先行扣减模式，得先取消之前的订单（这样才能解除相关锁定），而如果用户是直接退掉APP（如微信）然后再进入重新下单，由于无法简单找到之前的订单，会导致用户相关权益处于锁定状态而不可用。此时适合用后扣减模式，即不锁定，而是在支付回调中直接扣除相关权益。后扣减模式的风险在于：如果支付回调时间间隔较长（或者由于我们服务器临时不可用导致支付系统回调失败），则在这期间用户可以重复使用相关权益（券、积分等）。

支付回调：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-16/5f620f05a4624.png)
**注意：**
- 支付方式包括组合支付，需要保证组合支付的最终一致性，只有组合中的所有支付都成功才能算支付成功。
- 由于积分未算作支付方式，则在下单之前理论上需要有锁定积分的操作，防止在支付回调的时候积分不够扣减。
- 在组合支付中，如果只有一种支付提供回调模式，其他支付方式都是同步调用的，则在支付前先对同步支付方式做锁定操作，在支付回调中做确认或撤销操作；
- 在组合支付中，如果有多种支付方式是异步回调模式，则交易中心需要扮演协调者角色来协调多个异步事务执行，只有当所有支付方都回调成功，才算支付成功，如果有一方支付失败，则需要走补偿/撤销机制；

**组合支付：**
发起支付申请：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f62e44c1dab3.png)

支付回调：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f630d0fe204a.png)

### 退款流程：
发起退款申请：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f63197243d5e.png)
退款回调：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f632071ac10b.png)


### 分布式事务：
- 如果支付申请失败，则整个交易失败；
- 如果支付申请成功，不代表交易一定成功，最终要看支付回调；
- 如果支付回调告知支付失败，原则上整个交易失败；
- 如果支付回调告知支付成功（组合支付下需所有支付都成功），则原则上交易成功，此时需要将订单标记为支付成功，后续一系列处理由交易中心保证其最终成功；
- 也就是说，以支付回调结果作为交易成功与失败的分水岭，失败则回滚，成功则处理一系列其他事项；
- 为了保证分布式事务的成功，交易系统需要有哨兵机制，保证失败重试；


### SaaS 和 OS 的分期对接/迁移：
建议方案：
1.  SaaS 非核心场景对接交易中心（无感支付、闪付、被扫），验证一个月；
2. SaaS 核心场景对接交易中心（商户端、一键加油）；
3. OS 轻量版双屏机对接交易中心（轻量版双屏机目前对接的已经是线上的订单体系，因而无需做数据迁移）；
4. OS 老版双屏机对接交易中心（最困难的一块，也是公司整体交易体系的终极目标：真正的统一交易体系（包括报表））。这里涉及到老系统改造和数据迁移。建议按集团迁移。
