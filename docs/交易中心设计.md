标题 :
交易中心设计
 二级目录 :
随笔
 三级目录 :
可选
 序号 :
99
 
 
   
 
**结算系统**：记录交易信息用于做班结、财务报表以及其它统计信息。
**推送系统**：推送信息给商户端、大屏、双屏机等终端。
**发票系统**：自动开票等功能。
**通知包**：发通知。
**定级**：会员定级、查询等级信息。
**营销活动**：如满额送等，权益相关。
**OS**：线上线下订单同步。（由于目前一方面OS订单没有同步到线上订单和结算系统，另一方面很多报表是在OS实现的，所以SaaS订单会同步给OS，后面OS对接线上订单系统后，此处不再需要）。
​
核心系统：**用户、油号、订单、支付**，最少由这几个系统即可完成一次加油交易，相反，如果这几个系统任何一个出现问题，则无法完成交易。
​
### 下单流程：
下单：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-16/5f620ef489cc7.png)
**注意：**
- 用户在下单过程中可能会多次修改油枪、金额、支付方式等信息，每次修改后，交易中心需要重新计算可能的优惠组合列表，在将优惠组合返回给业务系统之前会做留存，防止在临界点发生不可预测的情况（比如分时优惠）。用户也可能会多次修改使用的优惠组合。这些过程中，不会涉及到跟订单系统的交互。
- **下单前预处理：**需要根据业务场景决定是否需要走“先行扣减（锁定）”模式。比如手机端一键加油，该场景下并不适合走先行扣减模式，因为用户在调起微信支付后还没有真正支付前，可能会取消支付，修改订单信息，此时只能算重新下单，如果走先行扣减模式，得先取消之前的订单（这样才能解除相关锁定），而如果用户是直接退掉APP（如微信）然后再进入重新下单，由于无法简单找到之前的订单，会导致用户相关权益处于锁定状态而不可用。此时适合用后扣减模式，即不锁定，而是在支付回调中直接扣除相关权益。后扣减模式的风险在于：如果支付回调时间间隔较长（或者由于我们服务器临时不可用导致支付系统回调失败），则在这期间用户可以重复使用相关权益（券、积分等）。
​
支付回调：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-16/5f620f05a4624.png)
**注意：**
- 支付方式包括组合支付，需要保证组合支付的最终一致性，只有组合中的所有支付都成功才能算支付成功。
- 由于积分未算作支付方式，则在下单之前理论上需要有锁定积分的操作，防止在支付回调的时候积分不够扣减。
- 在组合支付中，如果只有一种支付提供回调模式，其他支付方式都是同步调用的，则在支付前先对同步支付方式做锁定操作，在支付回调中做确认或撤销操作；
- 在组合支付中，如果有多种支付方式是异步回调模式，则交易中心需要扮演协调者角色来协调多个异步事务执行，只有当所有支付方都回调成功，才算支付成功，如果有一方支付失败，则需要走补偿/撤销机制；
​
**组合支付：**
发起支付申请：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f62e44c1dab3.png)
​
支付回调：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f630d0fe204a.png)
​
### 退款流程：
发起退款申请：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f63197243d5e.png)
退款回调：
![](http://showdoc.wcc.cn/server/../Public/Uploads/2020-09-17/5f632071ac10b.png)
​
​
### 分布式事务：
- 如果支付申请失败，则整个交易失败；
- 如果支付申请成功，不代表交易一定成功，最终要看支付回调；
- 如果支付回调告知支付失败，原则上整个交易失败；
- 如果支付回调告知支付成功（组合支付下需所有支付都成功），则原则上交易成功，此时需要将订单标记为支付成功，后续一系列处理由交易中心保证其最终成功；
- 也就是说，以支付回调结果作为交易成功与失败的分水岭，失败则回滚，成功则处理一系列其他事项；
- 为了保证分布式事务的成功，交易系统需要有哨兵机制，保证失败重试；
​
​
### SaaS 和 OS 的分期对接/迁移：
建议方案：
1.  SaaS 非核心场景对接交易中心（无感支付、闪付、被扫），验证一个月；
2. SaaS 核心场景对接交易中心（商户端、一键加油）；
3. OS 轻量版双屏机对接交易中心（轻量版双屏机目前对接的已经是线上的订单体系，因而无需做数据迁移）；
4. OS 老版双屏机对接交易中心（最困难的一块，也是公司整体交易体系的终极目标：真正的统一交易体系（包括报表））。这里涉及到老系统改造和数据迁移。建议按集团迁移。
