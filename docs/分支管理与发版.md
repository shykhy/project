### 分支管理：


### 说明：
有 4 种分支：feature/fix、test、release、master：
>> 1 feature/fix：开发分支/热修复分支。当需要开发新功能或修复 bug 时，开发人员从最新 master 分支创建新的特性分支，在这些分支上进行开发和自测。格式：feature-主开发人姓名-特性描述，如 feature-songlin-coupon-list。这种分支功能上线后即作废，需不定期清理；

>> 2 测试分支。功能开发完成后，开发人员将 feature 分支合并到 test 分支，再将 test 分支发到测试环境供测试人员测试（目前商户平台没有 test 分支，测试人员直接拿 feature 分支测试）。test 分支属于常驻分支，不过有时候因为操作问题导致污染，需要删掉当前 test 分支，然后从最新 master 创建新的 test 分支（test 重建）；

>> 3 release：功能测试验收完成后，开发人员从最新 master 分支创建 release 分支，按日期命名，格式：release-年月日.当天版本号，如release-20200312.01。将 feature 分支合并到 release 分支，发布到预发布环境给测试验收。预发布验收通过后，将 release 分支发布到生产环境，生产验收成功后将 release 合并到 master 分支。release 也是临时分支，功能上线后即作废。采用 release 分支发版的原因是，代码直到在生产验收通过之前都是和 master 隔离的，这样一旦代码有问题，不会污染 master，保证别人从 master 拉的代码一定没问题，同时它也能解决多人发布时对 master 分支对竞争使用问题；

>> 4 master：master 时常驻分支，上面的代码和生产环境保持一致。feature 和 release 都是从 master 分支创建的。不能在 master 分支上直接开发，正常情况下也不能用 master 分支发版。release 发布到线上并验证通过后，一定要记得合到 master 上，否则下一个发版会覆盖掉本次发布；

git 的常用命令说明：<a href="https://github.com/linvanda/think/blob/master/git%E4%BD%BF%E7%94%A8%E6%B1%87%E6%80%BB.md">git 使用汇总</a>

### 开发与发版规范：
#### 迭代：
1. 目前产研团队的研发周期是1个月，月初由产品和技术共同制定本月的需求列表（其中产品需求主要由产品主导，技术协助评估，技术需求由技术团队自己制定），这些计划列表构成每个团队和个人的月 KPI 指标，月末回顾完成率与完成质量，综合考虑评估每个团队和个人的 KPI 情况；
2. 月计划列表中的需求项根据重要性分为高、中、低级别，级别越高需要越优先完成，其占团队和个人 KPI 比例也越高；
3. 一个月分为 S1 和 S2 两个迭代，原则上每个迭代两周，在需求和任务分配时会明确指定其所属的迭代以及 deadline（提测、上线）。一般 S1 需求的提测时间（如果需要测试人员参与的话）在每月的 12 - 15 号，上线在 16 - 20 号。S2 需求提测一般在 20 - 24 号，上线在月末之前；
4. 实际中出现很多需求会累计到 22 号后集中提测，导致测试资源在 S1 比较空闲而 S2 压力很大，以至于很多需求最终完不成上线。开发人员需要经常回顾自己的进展，完成开发的需求要尽快提测，测试完成的需要尽快上线，完不成的工作需要及时跟团队负责人沟通；
#### 需求接收：
1. 从需求类型上分为**产品需求**和**技术需求**。产品需求由产品（以及 CS、运营、油站）提出，产品跟进；技术需求主要针对系统技术层面的优化，由技术人员提出并跟进；
2. 从需求接收方式上分为**迭代需求**（计划需求）和**临时需求**（插入需求）。迭代需求月初由产品、技术通过评审会议确定放入月迭代列表中，作为产研团队、小组以及个人月 KPI 的重要依据。临时需求是月中由产品或其他需求方临时提出的、紧急的（一般是走绿色通道的）需求，产研团队根据目前任务饱和度决定是否要调整迭代需求列表（即划掉某个优先级较低的需求）；
3. 所有的需求都需要在 TAPD 登记，目前基本都是在“全产品研发测试”这个项目下创建需求，产品需求的负责人是相关产品经理，技术需求负责人是技术经理；
4. 技术经理将需求拆分成相关任务分配给相关开发人员；
5. 原则上研发人员不直接从外部接收需求（bug 处理以及极小的修改除外），所有的需求由团队或项目的技术负责人拆分成任务分配到相关开发人员；
6. 任务分配时技术负责人和相关开发人员会评估工时，根据工时饱和度 + 熟悉度综合考虑任务分配；
#### 开发：

1. 开发人员接收到任务后，自己根据实际情况 + 需求优先级安排开发；

2. 开发人员和需求处理人需及时变更相关任务和需求的状态；

3. 团队在每日站会碰头，每个人阐述自己昨日工作、今日计划、整体进展。站会建议控制在 15 分钟以内；

4. 针对每个需求，开发人员需要从 master 拉取独立的分支开发，不可在同一个分支上开发多个需求，因为这样会导致多个需求相互影响，无法独立发版；

5. 对同一个项目的同一个需求，不同的开发人员建议都使用同一个分支开发（如前后端人员），避免相互合并代码的麻烦；

6. 创建开发分支：
   ```
    - git checkout master - git pull --rebase - git checkout -b feature-songlin-coupon-list - git push -u origin feature-songlin-coupon-list
   ```
7. 同一个需求涉及到多个开发者（甚至是跨团队）时，需要有一个主负责人，主负责人一般是后端开发者（也可以根据实际情况协调）。主负责人负责协调大家进度，统一提测、上线事宜；

8. 代码开发需符合团队相关开发规范，后面可能会启动代码评审机制；

9. 当某个项目发布生产并更新 master 分支后，该项目的其他开发人员应当及时将 master 最新代码合并到自己的开发分支；
#### 提测：
1. 某个需求的所有方面都开发完成并自测/联调通过后，由需求主开发负责人统一写提测邮件；
2. 提测邮件内容：
   - 标题：【提测申请】需求名称，和 TAPD 保持一致
   - 收件人：测试组
   - 抄送人：DEV 云研发组、相关产品人员、组外相关开发人员
   - 正文：
     1. 概括说明本需求内容；
     2. 对应的 TAPD 链接；
     3. 项目（git 和中文名称）、分支（除了商户平台是开发分支，其他都是 test 分支）；
     4. 开发、产品人员列表；
     5. 需测试的功能点提示列表（特别是隐藏功能点）；
     6. 其他注意事项说明；
3. 提测后，主开发负责人需要及时变更需求状态，改为“已提测”，相关开发人员需要及时变更自己的任务状态；
4. 提测后，相关开发人员可着手处理其他任务，但需要及时关注测试动态，对于测试提出的 bug，需第一时间解决，或者跟测试沟通紧急度来协商解决时间。原则上，应当在一天内解决。不可因 bug 长时间未得到解决而影响测试进度进而影响整个项目进度；
5. 如果提测后几天都不见动静，开发人员需要及时询问测试情况，防止测试人员没有看到邮件而遗漏；
6. 测试人员测试通过后，会回测试通过邮件，开发人员收到此邮件后，需及时准备预发布；
### 预发布
1. 主开发负责人收到测试通过邮件后，需及时准备预发布事宜。

2. 不像测试环境，要么所有的东西都在一个 test 分支测试（如 wx 等项目），要么有多个测试环境（如 mp）。每个项目只有一个预发布环境，因而在要上预发布之前，需要在群里面和团队其他成员确认有没有人正占用了预发布环境，如果有，则要等待。

3. 确认没有人占用环境后，从最新的 master 分支拉取 release 分支：

   ```
    - git checkout master - git pull --rebase - git checkout -b release-20200313.01 # 如果当天已经有其他发版了，就接着往后编号，创建的分支不可与已有分支冲突 - git merge --no-ff feature-songlin-coupon-list # 合并自己的开发分支 - git push -u origin release-20200313.01 # 推送到远程仓库
   ```

4. 在提测邮件的基础上写预发布邮件：

   - 标题：【预发布申请】需求名称，和 TAPD 保持一致

   - 收件人：运维组

   - 抄送人：测试组、DEV 云研发组、相关产品人员、组外相关开发人员

   - 正文：

     - 告知运维，测试已完成，申请发布预发布
     - 项目：项目名称（git 仓库名称），如“微信端(ip/wx)”，ip 是 git 的组名称
     - 分支：release-20200313.01
     - commit: 308d0bf831acb149a0dc5e348f83cef25adafd0a（目前我们采用分支发版策略，没有使用 tag 策略，所以同时要提供 commit）
     - 以上“项目、分支、commit”，如果涉及多个项目，按照发版顺序依次列出
     - SQL 语句（如果有。如果很多，需要以附件提供。需提示 SQL 执行风险。有时候，SQL 已经由开发人员自己在预发布执行了，那么这里就不用提供了）
     - 其他事项说明

   - 例如：

     > hi，运维：
     > 测试通过，麻烦发布到预发布环境验证。
     >
     > 1.财务结算子系统（负责人：汪剑）
     > 分支：release-20200313.01
     > 版本：e4371a569affe13862561b7aa3d5b939c9216aa7
     >
     > 2.逻辑业务子系统（负责人：汪剑）
     > 分支：release-20200313.02
     > 版本：9aca2d369826fd294b77fc23499d43654525212f

5. 运维发布后，由测试人员测试。如果运维一段时间没有处理，则需要及时提醒

#### 上线
1. 测试人员在预发布测试通过后，会回复测试通过邮件；
2. 主开发人员收到测试通过邮件后，需及时编写上线申请邮件：
   - 标题：【上线申请】需求名称，和 TAPD 保持一致
   - 收件人：运维组
   - 抄送人：测试组、DEV 云研发组、架构组、相关产品人员、组外相关开发人员、其他利益关系人（如 CS）
   - 正文：
     - 告知运维，预发布测试完成，申请上生产环境，自评发布风险（低、中、高）
     - 如果相对于预发布环境的 commit 有变动，则要重新在此说明（原则上不允许）
     - SQL。如果很多，则以附件提供。评估 SQL 执行风险
     - 如果有多个项目，说明发版顺序
     - 回滚方案
     - 其他注意事项说明
3. 上线申请邮件需要研发组负责人审批，审批人需要审核分支代码（如是否 master 最新代码、是否有明显的错误等）、发版流程、SQL、发版是否冲突，并评估发版风险，给出发版时间建议。一般低风险可以在白天非高峰期发布，中、高风险（如涉及到支付或涉及很多子系统发布的）需要在晚上 11 点以后发布；
4. 涉及到支付的，还需要研发中心总负责人审批；
5. 上线后，开发和测试人员需及时验证，并密切关注 CS 等人的反馈，发现问题，及时回滚；
6. 上线成功后，由各项目负责人（有些是团队负责人）将发版的 release 分支代码合并到 master，并在群里告知团队成员：
   - cd $proj_dir
   - git checkout $release-branch // 切换到 release 分支
   - git pull —rebase // 拉取 release 最新代码到本地
   - git checkout master // 切换到 master 分支
   - git pull —rebase // 拉取最新 master 代码到本地
   - git merge —no-ff $release-branch // 将 release 合并到 master，需要写合并说明，也就是本次发版内容（建议和上线邮件标题一致）
   - git push // 将 master 推送到远程仓库
